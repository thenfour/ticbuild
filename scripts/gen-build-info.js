const fs = require("fs");
const path = require("path");
const childProcess = require("child_process");

function safeExec(command) {
  try {
    return childProcess.execSync(command, { encoding: "utf8" }).trim();
  } catch {
    return null;
  }
}

function getBuildInfo() {
  // Read version from package.json
  const packageJsonPath = path.resolve(__dirname, "..", "package.json");
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
  const version = packageJson.version;

  const dirtyOutput = safeExec("git status --porcelain");
  const dirty = dirtyOutput == null ? null : dirtyOutput.length > 0;

  const commitHash = safeExec("git rev-parse --short HEAD");
  const lastCommitDate = safeExec("git log -1 --format=%cI");
  const buildDate = new Date().toISOString();

  return {
    version,
    dirty,
    buildDate,
    lastCommitDate,
    commitHash,
  };
}

const buildInfo = getBuildInfo();
const outPath = path.resolve(__dirname, "..", "src", "buildInfo.ts");

const contents = `// Auto-generated by scripts/gen-build-info.js. Do not edit.
export const buildInfo = ${JSON.stringify(buildInfo, null, 2)} as const;
`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, contents, "utf8");

console.log(`Wrote build info to ${outPath}`);
